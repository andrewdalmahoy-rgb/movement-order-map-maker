<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement Order Map Maker</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    header {
      background:#0b6fa6;
      color:white;
      padding:10px 16px;
      font-size: 20px;
      font-weight: 600;
    }

    .layout {
      position:absolute;
      top:48px;
      left:0; right:0; bottom:0;
    }

    #map {
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      z-index:1;
    }

    /* Keep Leaflet controls on the map, not over the sidebar */
    .leaflet-control-container {
      z-index: 500;
    }

    /* Sidebar */
    .sidebar {
      position:absolute;
      top:0; bottom:0; left:0;
      width:450px;
      background:#f4f5f7;
      box-shadow:2px 0 8px rgba(0,0,0,0.2);
      padding:12px;
      overflow-y:auto;
      z-index:900;
      transition:transform 0.3s ease;
    }
    .sidebar.hidden { transform:translateX(-100%); }

    .route-row {
      display:grid;
      grid-template-columns: 28px 1fr;
      grid-template-areas:
        "handle start"
        ". end"
        ". label"
        ". colors"
        ". buttons";
      gap:6px 10px;
      padding:10px;
      margin-bottom:10px;
      background:white;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.15);
    }

    .drag-handle {
      grid-area:handle;
      cursor:grab;
      font-size:20px;
      user-select:none;
      padding-top:4px;
    }

    .start-input,
    .end-input,
    .label-input {
      padding:7px;
      width:100%;
      border-radius:4px;
      border:1px solid #aaa;
      box-sizing:border-box;
    }

    .start-input { grid-area:start; }
    .end-input   { grid-area:end; }
    .label-input { grid-area:label; }

    .color-row {
      grid-area:colors;
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
    }

    .color-input {
      width:40px;
      height:32px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      padding:0;
    }

    .buttons-row {
      grid-area:buttons;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .removeRoute,
    .toggleRoute {
      border:none;
      border-radius:4px;
      padding:6px 10px;
      cursor:pointer;
      font-size:13px;
    }

    .removeRoute {
      background:#b22222;
      color:white;
    }

    .toggleRoute {
      background:#666;
      color:white;
    }

    button.full-btn, select.full-btn {
      width:100%;
      padding:8px 10px;
      border:none;
      border-radius:4px;
      margin-top:6px;
      background:#0b6fa6;
      color:white;
      font-size:15px;
      cursor:pointer;
      box-sizing:border-box;
    }
    select.full-btn {
      background:white;
      color:#333;
      border:1px solid #aaa;
    }

    .mode-row {
      font-size:14px;
      margin-top:6px;
    }

    .label-box {
      display:inline-block;
      padding:6px 10px;
      border-radius:8px;
      font-weight:bold;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      line-height:1.2;
      pointer-events:none;
    }

    /* Floating toggle button */
    .panel-toggle {
      position:absolute;
      bottom:16px;
      left:16px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:1px solid #ccc;
      background:white;
      color:#333;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      z-index:1000;
    }

    /* Free marker button */
    .free-marker-btn {
      position:absolute;
      bottom:78px;
      left:16px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:1px solid #ccc;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      z-index:1000;
    }

    /* Popup editor (for free markers) */
    .marker-editor { font-size:13px; padding:4px; }
    .marker-editor h4 { margin:0 0 6px; font-size:14px; }
    .marker-editor label { display:block; margin-top:4px; font-weight:bold; }
    .marker-editor input[type=text] {
      width:100%; padding:4px 6px;
      border-radius:4px; border:1px solid #aaa;
      box-sizing:border-box;
    }
    .marker-editor input[type=color] {
      width:40px; height:24px; border:none; border-radius:4px;
      margin-left:4px; cursor:pointer;
    }
    .marker-editor-buttons {
      display:flex; gap:6px; margin-top:8px;
    }
    .marker-editor-save {
      flex:1; background:#0b6fa6; color:white; border:none;
      padding:5px; border-radius:4px; cursor:pointer;
    }
    .marker-editor-delete {
      flex:1; background:#b22222; color:white; border:none;
      padding:5px; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body>

<header>Movement Order Map Maker</header>

<div class="layout">
  <div id="map"></div>

  <button id="panelToggle" class="panel-toggle">‚úï</button>
  <button id="addFreeMarkerBtn" class="free-marker-btn">üìç</button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <h3>Routes</h3>
    <div id="routeContainer"></div>
    <button id="addRouteBtn" class="full-btn">‚ûï Add Route</button>

    <h3>Font</h3>
    <select id="labelFont" class="full-btn">
      <option>Arial</option><option>Helvetica</option>
      <option>Verdana</option><option>Georgia</option>
      <option>Times New Roman</option><option>Courier New</option>
    </select>

    <h3>Font Size</h3>
    <select id="labelFontSize" class="full-btn">
      <option>12px</option>
      <option selected>14px</option>
      <option>16px</option><option>18px</option><option>20px</option>
    </select>

    <h3>Travel Mode</h3>
    <div class="mode-row">
      <label><input name="mode" type="radio" value="DRIVE" checked> Driving</label><br>
      <label><input name="mode" type="radio" value="WALK"> Walking</label>
    </div>

    <button id="drawAllBtn" class="full-btn">Draw All Routes</button>
    <button id="recenterBtn" class="full-btn">üîç Recenter Visible Routes</button>
    <button id="satToggle" class="full-btn">üõ∞ Satellite View</button>
  </div>
</div>

<!-- Google Places & Routes -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M&libraries=places"></script>

<script>
/* ======================== MAP ======================== */
const map = L.map("map").setView([52.5, -1.5], 6);

const streets = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom:19 }
).addTo(map);

const esriSat = L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 { maxZoom:19 }
);

let satelliteOn = false;

const routeLayer = L.layerGroup().addTo(map);
const routeMarkerLayer = L.layerGroup().addTo(map);
const freeMarkerLayer = L.layerGroup().addTo(map);

/* ======================== SIDEBAR TOGGLE ======================== */
const sidebar = document.getElementById("sidebar");
const panelToggle = document.getElementById("panelToggle");
let panelOpen = true;

function updatePanelState(){
  if(panelOpen){
    sidebar.classList.remove("hidden");
    panelToggle.textContent="‚úï";
  } else {
    sidebar.classList.add("hidden");
    panelToggle.textContent="‚â°";
  }
  setTimeout(()=>map.invalidateSize(),200);
}
panelToggle.addEventListener("click",()=>{
  panelOpen=!panelOpen;
  updatePanelState();
});
updatePanelState();

/* ======================== SATELLITE ======================== */
document.getElementById("satToggle").addEventListener("click",()=>{
  satelliteOn=!satelliteOn;
  if(satelliteOn){ map.removeLayer(streets); esriSat.addTo(map); }
  else { map.removeLayer(esriSat); streets.addTo(map); }
  setTimeout(()=>map.invalidateSize(),150);
});

/* ======================== AUTOCOMPLETE ======================== */
const startAcMap = new Map();
const endAcMap   = new Map();
function attachAutocomplete(input, mapObj){
  const ac=new google.maps.places.Autocomplete(input,{fields:["geometry","formatted_address"]});
  mapObj.set(input,ac);
}

/* ======================== ROUTES MODEL ======================== */
const routeContainer=document.getElementById("routeContainer");
let routes = [];
let nextRouteId = 1;

function makeColoredMarker(color){
  const svg=`
    <svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 0
               C7 0 0 7 0 16
               C0 30 16 48 16 48
               C16 48 32 30 32 16
               C32 7 25 0 16 0Z"
            fill="${color}"
            stroke="white" stroke-width="2"/>
      <circle cx="16" cy="16" r="6" fill="white"/>
    </svg>`;
  return L.icon({
    iconUrl:"data:image/svg+xml;base64,"+btoa(svg),
    iconSize:[32,48],
    iconAnchor:[16,48]
  });
}

function computeMidpoint(latlngs){
  if(!latlngs || latlngs.length===0) return null;
  const idx = Math.floor(latlngs.length/2);
  return latlngs[idx];
}

function createRouteRow(defaultLabel="Route"){
  const row=document.createElement("div");
  row.className="route-row";

  row.innerHTML=`
    <div class="drag-handle">‚ò∞</div>
    <input class="start-input" placeholder="Start address or postcode" />
    <input class="end-input" placeholder="End address or postcode" />
    <input class="label-input" placeholder="${defaultLabel}" />
    <div class="color-row">
      <label>Box:</label>
      <input type="color" class="color-input boxColor" value="#2e8b57"/>
      <label>Text:</label>
      <input type="color" class="color-input textColor" value="#ffffff"/>
    </div>
    <div class="buttons-row">
      <button class="toggleRoute">üôà Hide</button>
      <button class="removeRoute">‚úñ Delete</button>
    </div>
  `;

  routeContainer.appendChild(row);

  const startInput = row.querySelector(".start-input");
  const endInput   = row.querySelector(".end-input");
  const labelInput = row.querySelector(".label-input");
  const boxInput   = row.querySelector(".boxColor");
  const textInput  = row.querySelector(".textColor");
  const toggleBtn  = row.querySelector(".toggleRoute");
  const removeBtn  = row.querySelector(".removeRoute");

  attachAutocomplete(startInput, startAcMap);
  attachAutocomplete(endInput,   endAcMap);

  const routeObj = {
    id: nextRouteId++,
    row,
    startInput,
    endInput,
    labelInput,
    boxInput,
    textInput,
    visible: true,
    startLatLng: null,
    endLatLng: null,
    polyline: null,
    startMarker: null,
    endMarker: null,
    labelMarker: null
  };

  toggleBtn.addEventListener("click",()=>{
    routeObj.visible = !routeObj.visible;
    toggleBtn.textContent = routeObj.visible ? "üôà Hide" : "üëÅ Show";

    // Show/hide existing layers if present
    if(routeObj.polyline){
      if(routeObj.visible){
        routeLayer.addLayer(routeObj.polyline);
      } else {
        routeLayer.removeLayer(routeObj.polyline);
      }
    }
    [routeObj.startMarker, routeObj.endMarker, routeObj.labelMarker].forEach(m=>{
      if(!m) return;
      if(routeObj.visible){
        routeMarkerLayer.addLayer(m);
      } else {
        routeMarkerLayer.removeLayer(m);
      }
    });
  });

  removeBtn.addEventListener("click",()=>{
    // Remove from map
    if(routeObj.polyline) routeLayer.removeLayer(routeObj.polyline);
    [routeObj.startMarker, routeObj.endMarker, routeObj.labelMarker].forEach(m=>{
      if(m) routeMarkerLayer.removeLayer(m);
    });
    // Remove from model + DOM
    routes = routes.filter(r=>r!==routeObj);
    row.remove();
  });

  routes.push(routeObj);
  return routeObj;
}

/* Initial route */
createRouteRow("Route 1");

Sortable.create(routeContainer,{handle:".drag-handle",animation:150});

document.getElementById("addRouteBtn").addEventListener("click",()=>{
  createRouteRow("Route");
});

/* ================= POLYLINE DECODER ================= */
function decodePolyline(encoded){
  let coords=[],lat=0,lng=0,index=0;
  while(index<encoded.length){
    let b,shift=0,result=0;
    do{ b=encoded.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
    const dlat=(result&1)?~(result>>1):(result>>1); lat+=dlat;

    shift=0; result=0;
    do{ b=encoded.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
    const dlng=(result&1)?~(result>>1):(result>>1); lng+=dlng;

    coords.push([lat/1e5,lng/1e5]);
  }
  return coords;
}

/* ================= GOOGLE ROUTES ================= */
async function computeRoute(start,end,mode){
  const body={
    origin:{location:{latLng:{latitude:start[0],longitude:start[1]}}},
    destination:{location:{latLng:{latitude:end[0],longitude:end[1]}}},
    travelMode:mode
  };

  const res=await fetch("https://routes.googleapis.com/directions/v2:computeRoutes",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Goog-Api-Key":"AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M",
      "X-Goog-FieldMask":"routes.polyline.encodedPolyline"
    },
    body:JSON.stringify(body)
  });

  const data=await res.json();
  if(!data.routes) return [];
  return decodePolyline(data.routes[0].polyline.encodedPolyline);
}

/* ================= DRAW / UPDATE ONE ROUTE ================= */
async function drawRoute(routeObj, mode, fit){
  // Clear previous layers
  if(routeObj.polyline) routeLayer.removeLayer(routeObj.polyline);
  [routeObj.startMarker, routeObj.endMarker, routeObj.labelMarker].forEach(m=>{
    if(m) routeMarkerLayer.removeLayer(m);
  });

  // Resolve start & end coords
  // First try stored latLng (from previous drag), else use Places
  let startLatLng = routeObj.startLatLng;
  let endLatLng   = routeObj.endLatLng;

  if(!startLatLng){
    const ac = startAcMap.get(routeObj.startInput);
    const place = ac && ac.getPlace && ac.getPlace();
    if(!place || !place.geometry){
      // If no geometry, skip drawing this route
      return;
    }
    startLatLng = [place.geometry.location.lat(), place.geometry.location.lng()];
    routeObj.startLatLng = startLatLng;
  }

  if(!endLatLng){
    const ac = endAcMap.get(routeObj.endInput);
    const place = ac && ac.getPlace && ac.getPlace();
    if(!place || !place.geometry){
      return;
    }
    endLatLng = [place.geometry.location.lat(), place.geometry.location.lng()];
    routeObj.endLatLng = endLatLng;
  }

  const coords = await computeRoute(startLatLng,endLatLng,mode);
  if(!coords.length) return;

  const boxColor  = routeObj.boxInput.value;
  const textColor = routeObj.textInput.value;
  const labelText = routeObj.labelInput.value || "Route";

  const latlngs = coords.map(p=>[p[0],p[1]]);
  const polyline = L.polyline(latlngs,{
    color:boxColor,
    weight:5,
    dashArray: mode==="WALK"?"6,10":null
  });

  routeObj.polyline = polyline;
  if(routeObj.visible){
    polyline.addTo(routeLayer);
  }

  const font=document.getElementById("labelFont").value;
  const size=document.getElementById("labelFontSize").value;

  const startMarker = L.marker(startLatLng,{
    draggable:true,
    icon: makeColoredMarker(boxColor)
  });
  const endMarker = L.marker(endLatLng,{
    draggable:true,
    icon: makeColoredMarker(boxColor)
  });

  if(routeObj.visible){
    startMarker.addTo(routeMarkerLayer);
    endMarker.addTo(routeMarkerLayer);
  }

  const mid = computeMidpoint(latlngs);
  let labelMarker = null;
  if(mid){
    labelMarker = L.marker(mid,{
      icon:L.divIcon({
        html:`<div class="label-box"
                 style="background:${boxColor}; color:${textColor};
                        font-family:${font}; font-size:${size};">
                ${labelText}
              </div>`,
        className:"",
        iconSize:[0,0],
        iconAnchor:[0,-10]
      }),
      interactive:false
    });
    if(routeObj.visible){
      labelMarker.addTo(routeMarkerLayer);
    }
  }

  routeObj.startMarker = startMarker;
  routeObj.endMarker   = endMarker;
  routeObj.labelMarker = labelMarker;

  function markerDragHandler(isStart){
    return async (e)=>{
      const lat=e.target.getLatLng().lat;
      const lng=e.target.getLatLng().lng;
      if(isStart) routeObj.startLatLng=[lat,lng];
      else        routeObj.endLatLng=[lat,lng];

      // Optional: show coords in inputs if you like
      // (commented out to keep original text)
      // (routeObj[isStart ? 'startInput' : 'endInput'].value = `(${lat.toFixed(5)}, ${lng.toFixed(5)})`);

      // Redraw this route, keeping visibility flag
      await drawRoute(routeObj, mode, false);
    };
  }

  startMarker.on("dragend",markerDragHandler(true));
  endMarker.on("dragend",markerDragHandler(false));

  // Fit map to this route if requested
  if(fit){
    map.fitBounds(polyline.getBounds(),{padding:[40,40]});
  }
}

/* ================= DRAW ALL ROUTES ================= */
document.getElementById("drawAllBtn").addEventListener("click",async()=>{
  const mode=document.querySelector('input[name="mode"]:checked').value;

  for(const r of routes){
    await drawRoute(r,mode,false);
  }

  // After drawing all visible routes, recenter to all
  let b=null;
  routeLayer.eachLayer(l=>{
    if(!b) b=l.getBounds(); else b.extend(l.getBounds());
  });
  if(b) map.fitBounds(b,{padding:[40,40]});
});

/* ================= RECENTER VISIBLE ROUTES ================= */
document.getElementById("recenterBtn").addEventListener("click",()=>{
  let b=null;
  routeLayer.eachLayer(l=>{
    if(!b) b=l.getBounds(); else b.extend(l.getBounds());
  });
  if(b) map.fitBounds(b,{padding:[40,40]});
});

/* ================= FREE-PLACE MARKERS ================= */
let dropMode=false;
document.getElementById("addFreeMarkerBtn").addEventListener("click",()=>{
  dropMode=true;
  alert("Click the map to place a custom marker.");
});

let freeMarkerId=1;
const freeMarkers=[];

function createFreeMarker(latlng,text,boxColor,textColor){
  const font=document.getElementById("labelFont").value;
  const size=document.getElementById("labelFontSize").value;

  const id=freeMarkerId++;

  const marker=L.marker(latlng,{
    draggable:true,
    icon: makeColoredMarker(boxColor)
  }).addTo(freeMarkerLayer);

  const labelMarker=L.marker(latlng,{
    icon:L.divIcon({
      html:`<div class="label-box"
               style="background:${boxColor}; color:${textColor};
                      font-family:${font}; font-size:${size};">
              ${text}
            </div>`,
      className:"",
      iconSize:[0,0],
      iconAnchor:[0,-10]
    }),
    interactive:false
  }).addTo(freeMarkerLayer);

  const fm={id,marker,labelMarker,text,boxColor,textColor};
  freeMarkers.push(fm);

  marker.on("drag",e=>labelMarker.setLatLng(e.latlng));
  marker.on("click",()=>openFreeMarkerEditor(fm));
}

function openFreeMarkerEditor(fm){
  const html=`
   <div class="marker-editor">
     <h4>Edit Marker</h4>

     <label>Label:</label>
     <input id="fm-label-${fm.id}" value="${fm.text}" />

     <label>Box:
       <input type="color" id="fm-box-${fm.id}" value="${fm.boxColor}">
     </label>

     <label>Text:
       <input type="color" id="fm-text-${fm.id}" value="${fm.textColor}">
     </label>

     <div class="marker-editor-buttons">
       <button class="marker-editor-save" id="fm-save-${fm.id}">Save</button>
       <button class="marker-editor-delete" id="fm-del-${fm.id}">Delete</button>
     </div>
   </div>
  `;

  L.popup()
    .setLatLng(fm.marker.getLatLng())
    .setContent(html)
    .openOn(map);

  setTimeout(()=>{
    const labelIn=document.getElementById(`fm-label-${fm.id}`);
    const boxIn=document.getElementById(`fm-box-${fm.id}`);
    const textIn=document.getElementById(`fm-text-${fm.id}`);

    document.getElementById(`fm-save-${fm.id}`).onclick=()=>{
      fm.text=labelIn.value||"Point";
      fm.boxColor=boxIn.value;
      fm.textColor=textIn.value;

      const font=document.getElementById("labelFont").value;
      const size=document.getElementById("labelFontSize").value;

      fm.labelMarker.setIcon(L.divIcon({
        html:`<div class="label-box"
                 style="background:${fm.boxColor}; color:${fm.textColor};
                        font-family:${font}; font-size:${size};">
                ${fm.text}
              </div>`,
        className:"",
        iconSize:[0,0],
        iconAnchor:[0,-10]
      }));

      fm.marker.setIcon(makeColoredMarker(fm.boxColor));

      map.closePopup();
    };

    document.getElementById(`fm-del-${fm.id}`).onclick=()=>{
      freeMarkerLayer.removeLayer(fm.marker);
      freeMarkerLayer.removeLayer(fm.labelMarker);
      const idx=freeMarkers.findIndex(x=>x.id===fm.id);
      freeMarkers.splice(idx,1);
      map.closePopup();
    };

  },20);
}

map.on("click",e=>{
  if(!dropMode) return;
  dropMode=false;

  const t=prompt("Marker label text:","Point");
  if(t===null) return;

  createFreeMarker(
    e.latlng,
    t||"Point",
    "#2e8b57",
    "#ffffff"
  );
});
</script>

</body>
</html>
