<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-Stop Route Planner</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    header { background:#0b6fa6; color:white; padding:10px 16px; }
    #map { height: 70vh; width: 100%; }

    .controls {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stop-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .address-input {
      width: 320px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    .stop-row input[type=text] {
      padding: 6px;
      width: 150px;
      border: 1px solid #aaa;
      border-radius: 4px;
    }

    .stop-row input[type=color] {
      width: 42px;
      height: 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .stop-row button {
      padding: 8px 12px;
      background:#b22222;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }

    #addStopBtn, #routeBtn {
      padding: 10px 14px;
      background:#0b6fa6;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
      width: 180px;
      font-size: 16px;
    }

    .label-box {
      display:inline-block;
      padding:7px 12px;
      border-radius:8px;
      font-weight:600;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      transform: translateY(-12px);
    }
  </style>
</head>

<body>

<header><h2>Multi-Stop Route Planner</h2></header>

<div class="controls">

  <div id="stopContainer">

    <!-- Default START row -->
    <div class="stop-row">
      <input type="text" class="address-input" placeholder="Start address">
      <input type="text" class="label" placeholder="Start">
      <input type="color" class="boxColor" value="#2e8b57">
      <input type="color" class="textColor" value="#ffffff">
      <button class="removeStop">✖</button>
    </div>

    <!-- Default END row -->
    <div class="stop-row">
      <input type="text" class="address-input" placeholder="End address">
      <input type="text" class="label" placeholder="End">
      <input type="color" class="boxColor" value="#b22222">
      <input type="color" class="textColor" value="#ffffff">
      <button class="removeStop">✖</button>
    </div>

  </div>

  <button id="addStopBtn">➕ Add Stop</button>

  <h3>Label Font Settings</h3>
  <div class="stop-row">
    <label>Font:</label>
    <input type="text" id="labelFont" value="Arial">
    <label>Size:</label>
    <input type="text" id="labelFontSize" value="14px">
  </div>

  <button id="routeBtn">Show Route</button>
</div>

<div id="map"></div>

<script>
/* ---------------- USER CONFIG ---------------- */
const apiKey = "YOUR_KEY_HERE";   // ← ← ← REPLACE THIS

/* ---------------- MAP SETUP ---------------- */
const map = L.map("map").setView([52.5, -1.5], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

let markerGroup = L.layerGroup().addTo(map);
let routeLayers = [];

/* MARKER ICONS */
function icon(url) {
  return L.icon({
    iconUrl: url,
    shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
    iconSize:[25,41],
    iconAnchor:[12,41]
  });
}

const iconGreen = icon("https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png");
const iconRed   = icon("https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png");
const iconBlue  = icon("https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png");

/* AUTOCOMPLETE STORAGE */
const acMap = new Map();

/* ATTACH AUTOCOMPLETE */
function attachAutocomplete(input) {
  if (!window.google || !google.maps.places) return;

  const ac = new google.maps.places.Autocomplete(input, {
    fields: ["geometry", "formatted_address"]
  });

  acMap.set(input, ac);
}

/* GEOCODE FALLBACK */
async function geocodeText(query) {
  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M`;
  const res = await fetch(url);
  const data = await res.json();

  if (!data.results || !data.results.length) {
    throw new Error("Could not geocode: " + query);
  }

  const loc = data.results[0].geometry.location;
  return [loc.lat, loc.lng];
}

/* CLEAR MAP */
function clearMap() {
  markerGroup.clearLayers();
  routeLayers.forEach(r => map.removeLayer(r));
  routeLayers = [];
}

/* ORS ROUTING — FIXED WITH BEARER AUTH */
async function requestORS(start, end) {
  const response = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + apiKey,        // ←← FIX
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      coordinates: [
        [start[1], start[0]],
        [end[1], end[0]]
      ]
    })
  });

  if (!response.ok) {
    const text = await response.text();
    throw new Error("ORS error " + response.status + ": " + text);
  }

  return response.json();
}

/* ADD STOP ROW */
document.getElementById("addStopBtn").addEventListener("click", () => {
  const row = document.createElement("div");
  row.className = "stop-row";

  row.innerHTML = `
    <input type="text" class="address-input" placeholder="Address or postcode">
    <input type="text" class="label" placeholder="Label">
    <input type="color" class="boxColor" value="#2e8b57">
    <input type="color" class="textColor" value="#ffffff">
    <button class="removeStop">✖</button>
  `;

  row.querySelector(".removeStop").addEventListener("click", () => row.remove());
  document.getElementById("stopContainer").appendChild(row);

  attachAutocomplete(row.querySelector(".address-input"));
});

/* MAIN ROUTE BUTTON */
document.getElementById("routeBtn").addEventListener("click", async () => {
  try {
    clearMap();

    const rows = [...document.querySelectorAll(".stop-row")];
    const coords = [];
    const labels = [];
    const boxColors = [];
    const textColors = [];

    for (let row of rows) {
      const input = row.querySelector(".address-input");
      const ac = acMap.get(input);
      const typed = input.value.trim();

      let place = ac ? ac.getPlace() : null;
      let latLng;

      if (place && place.geometry) {
        latLng = [
          place.geometry.location.lat(),
          place.geometry.location.lng()
        ];
      } else {
        latLng = await geocodeText(typed);
      }

      coords.push(latLng);
      labels.push(row.querySelector(".label").value || "Stop");
      boxColors.push(row.querySelector(".boxColor").value);
      textColors.push(row.querySelector(".textColor").value);
    }

    /* DRAW MARKERS */
    const font = document.getElementById("labelFont").value;
    const size = document.getElementById("labelFontSize").value;

    coords.forEach((c, i) => {
      let ic = i === 0 ? iconGreen :
               i === coords.length - 1 ? iconRed : iconBlue;

      L.marker(c, { icon: ic }).addTo(markerGroup);

      L.marker(c, {
        icon: L.divIcon({
          html: `<div class="label-box"
                      style="background:${boxColors[i]};
                             color:${textColors[i]};
                             font-family:${font};
                             font-size:${size};">
                  ${labels[i]}
                 </div>`,
          className:"",
          iconSize:[0,0],
          iconAnchor:[40,30]
        }),
        interactive:false
      }).addTo(markerGroup);
    });

    /* DRAW ROUTE */
    for (let i = 0; i < coords.length - 1; i++) {
      const r = await requestORS(coords[i], coords[i+1]);
      const line = r.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

      const seg = L.polyline(line, {
        color: boxColors[i],
        weight: 6
      }).addTo(map);

      routeLayers.push(seg);
    }

    /* FIT MAP */
    let bounds = L.latLngBounds();
    routeLayers.forEach(r => bounds.extend(r.getBounds()));
    map.fitBounds(bounds, { padding:[40,40] });

  } catch (err) {
    alert("Error: " + err.message);
    console.error(err);
  }
});
</script>

<!-- GOOGLE PLACES API -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M&libraries=places"
  onload="document.querySelectorAll('.address-input').forEach(i => attachAutocomplete(i));">
</script>

</body>
</html>
