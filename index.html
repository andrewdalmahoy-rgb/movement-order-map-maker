<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement Order Map Maker</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    header {
      background:#0b6fa6;
      color:white;
      padding:10px 16px;
      font-size: 20px;
      font-weight: 600;
    }

    .layout {
      position:absolute;
      top:48px;
      left:0; right:0; bottom:0;
    }

    #map {
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      z-index:1;
    }

    /* Ensure Leaflet UI controls are visible */
    .leaflet-control-container {
      z-index: 500;
    }

    /* Sidebar */
    .sidebar {
      position:absolute;
      top:0; bottom:0; left:0;
      width:450px;
      background:#f4f5f7;
      box-shadow:2px 0 8px rgba(0,0,0,0.2);
      padding:12px;
      overflow-y:auto;
      z-index:900;
      transition:transform 0.3s ease;
    }
    .sidebar.hidden { transform:translateX(-100%); }

    .route-row {
      display:grid;
      grid-template-columns: 28px 1fr;
      grid-template-areas: "handle main";
      gap:6px 10px;
      padding:10px;
      margin-bottom:10px;
      background:white;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.15);
    }

    .drag-handle {
      grid-area:handle;
      cursor:grab;
      font-size:20px;
      user-select:none;
      padding-top:4px;
    }

    .route-main {
      grid-area:main;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .point-row {
      display:grid;
      grid-template-columns: 70px 1fr 1fr;
      grid-template-areas: "label addr lbl";
      column-gap:6px;
      align-items:center;
    }

    .point-label {
      grid-area:label;
      font-size:13px;
      font-weight:bold;
    }

    .addr-input,
    .name-input {
      padding:6px;
      border-radius:4px;
      border:1px solid #aaa;
      font-size:13px;
      width:100%;
      box-sizing:border-box;
    }

    .addr-input { grid-area:addr; }
    .name-input { grid-area:lbl; }

    .color-row {
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
    }

    .color-input {
      width:40px;
      height:32px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      padding:0;
    }

    .buttons-row {
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .removeRoute,
    .toggleRoute {
      border:none;
      border-radius:4px;
      padding:6px 10px;
      cursor:pointer;
      font-size:13px;
    }

    .removeRoute {
      background:#b22222;
      color:white;
    }

    .toggleRoute {
      background:#666;
      color:white;
    }

    .full-btn {
      width:100%;
      padding:8px 10px;
      border:none;
      border-radius:4px;
      margin-top:6px;
      background:#0b6fa6;
      color:white;
      font-size:15px;
      cursor:pointer;
      box-sizing:border-box;
    }

    /* Label box style */
    .label-box {
      display:inline-block;
      padding:6px 10px;
      border-radius:8px;
      font-weight:bold;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      line-height:1.2;
      pointer-events:none;
    }

    /* Floating buttons */
    .panel-toggle,
    .free-marker-btn {
      position:absolute;
      bottom:16px;
      left:16px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:1px solid #ccc;
      background:white;
      color:#333;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      z-index:1000;
    }
    .free-marker-btn {
      bottom:78px;
    }

    /* Popup editor (for free markers) */
    .marker-editor { font-size:13px; padding:4px; }
    .marker-editor h4 { margin:0 0 6px; font-size:14px; }
    .marker-editor label { display:block; margin-top:4px; font-weight:bold; }
    .marker-editor input[type=text] {
      width:100%; padding:4px 6px;
      border-radius:4px; border:1px solid #aaa;
      box-sizing:border-box;
    }
    .marker-editor input[type=color] {
      width:40px; height:24px; border:none; border-radius:4px;
      margin-left:4px; cursor:pointer;
    }
    .marker-editor-buttons {
      display:flex; gap:6px; margin-top:8px;
    }
    .marker-editor-save {
      flex:1; background:#0b6fa6; color:white; border:none;
      padding:5px; border-radius:4px; cursor:pointer;
    }
    .marker-editor-delete {
      flex:1; background:#b22222; color:white; border:none;
      padding:5px; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body>

<header>Movement Order Map Maker</header>

<div class="layout">
  <div id="map"></div>

  <button id="panelToggle" class="panel-toggle">‚úï</button>
  <button id="addFreeMarkerBtn" class="free-marker-btn">üìç</button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <h3>Routes</h3>
    <div id="routeContainer"></div>
    <button id="addRouteBtn" class="full-btn">‚ûï Add Route</button>

    <h3>Label Style</h3>
    <div style="display:flex; gap:10px;">
      <select id="labelFont" style="flex:2; padding:6px;">
        <option>Arial</option><option>Helvetica</option>
        <option>Verdana</option><option>Georgia</option>
        <option>Times New Roman</option><option>Courier New</option>
      </select>

      <select id="labelFontSize" style="flex:1; padding:6px;">
        <option>12px</option>
        <option selected>14px</option>
        <option>16px</option><option>18px</option><option>20px</option>
      </select>
    </div>

    <h3>Travel Mode</h3>
    <label><input name="mode" type="radio" value="DRIVE" checked> Driving</label><br>
    <label><input name="mode" type="radio" value="WALK"> Walking</label>

    <button id="drawAllBtn" class="full-btn">Draw All Routes</button>
    <button id="satToggle" class="full-btn">üõ∞ Satellite View</button>
  </div>
</div>

<!-- Google Places & Routes -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M&libraries=places"></script>

<script>
/* ======================== MAP ======================== */
const map = L.map("map").setView([52.5, -1.5], 6);

const streets = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom:19 }
).addTo(map);

const esriSat = L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 { maxZoom:19 }
);

let satelliteOn = false;

const routeLayer = L.layerGroup().addTo(map);
const routeMarkerLayer = L.layerGroup().addTo(map);
const freeMarkerLayer = L.layerGroup().addTo(map);

/* ======================== SIDEBAR TOGGLE ======================== */
const sidebar = document.getElementById("sidebar");
const panelToggle = document.getElementById("panelToggle");
let panelOpen = true;

panelToggle.addEventListener("click",()=>{
  panelOpen = !panelOpen;
  sidebar.classList.toggle("hidden", !panelOpen);
  setTimeout(()=>map.invalidateSize(),200);
});

/* ======================== SATELLITE ======================== */
document.getElementById("satToggle").addEventListener("click",()=>{
  satelliteOn = !satelliteOn;
  if(satelliteOn){
    map.removeLayer(streets);
    esriSat.addTo(map);
  } else {
    map.removeLayer(esriSat);
    streets.addTo(map);
  }
});

/* ======================== AUTOCOMPLETE ======================== */
const startAcMap = new Map();
const endAcMap   = new Map();

function attachAC(input, mapObj){
  const ac=new google.maps.places.Autocomplete(input,{fields:["geometry"]});
  mapObj.set(input,ac);
}

/* ======================== ROUTES MODEL ======================== */
let routes = [];
let nextRouteId = 1;
const routeContainer = document.getElementById("routeContainer");

function makeMarker(color){
  const svg = `
    <svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 0 C7 0 0 7 0 16 C0 30 16 48 16 48 C16 48 32 30 32 16 C32 7 25 0 16 0Z"
            fill="${color}" stroke="white" stroke-width="2"/>
      <circle cx="16" cy="16" r="6" fill="white"/>
    </svg>`;
  return L.icon({
    iconUrl:"data:image/svg+xml;base64,"+btoa(svg),
    iconSize:[32,48],
    iconAnchor:[16,48]
  });
}

function createRouteRow(){
  const row = document.createElement("div");
  row.className = "route-row";
  row.innerHTML = `
    <div class="drag-handle">‚ò∞</div>
    <div class="route-main">
      <div class="point-row">
        <div class="point-label">Start:</div>
        <input class="addr-input start-addr" placeholder="Start address or postcode" />
        <input class="name-input start-name" placeholder="Start label" />
      </div>
      <div class="point-row">
        <div class="point-label">End:</div>
        <input class="addr-input end-addr" placeholder="End address or postcode" />
        <input class="name-input end-name" placeholder="End label" />
      </div>
      <div class="color-row">
        <label>Box:</label>
        <input type="color" class="color-input boxColor" value="#2e8b57"/>
        <label>Text:</label>
        <input type="color" class="color-input textColor" value="#ffffff"/>
      </div>
      <div class="buttons-row">
        <button class="toggleRoute">üôà Hide</button>
        <button class="removeRoute">‚úñ Delete</button>
      </div>
    </div>
  `;

  routeContainer.appendChild(row);

  const r = {
    id: nextRouteId++,
    row,
    startAddrInput:  row.querySelector(".start-addr"),
    startLabelInput: row.querySelector(".start-name"),
    endAddrInput:    row.querySelector(".end-addr"),
    endLabelInput:   row.querySelector(".end-name"),
    boxInput:        row.querySelector(".boxColor"),
    textInput:       row.querySelector(".textColor"),
    visible:         true,
    polyline:        null,
    startLatLng:     null,
    endLatLng:       null,
    startMarker:     null,
    endMarker:       null,
    startLabelMarker:null,
    endLabelMarker:  null
  };

  attachAC(r.startAddrInput, startAcMap);
  attachAC(r.endAddrInput,   endAcMap);

  const toggleBtn = row.querySelector(".toggleRoute");
  const removeBtn = row.querySelector(".removeRoute");

  toggleBtn.onclick = () => toggleRoute(r, toggleBtn);
  removeBtn.onclick = () => removeRoute(r);

  routes.push(r);
  return r;
}

createRouteRow();

/* ‚≠ê FIXED: Add Route handler */
document.getElementById("addRouteBtn").onclick = () => {
  createRouteRow();
};

Sortable.create(routeContainer,{handle:".drag-handle",animation:150});

/* ======================== ROUTE ACTIONS ======================== */
function removeRoute(r){
  if(r.polyline) routeLayer.removeLayer(r.polyline);
  [r.startMarker,r.endMarker,r.startLabelMarker,r.endLabelMarker].forEach(m=>{
    if(m) routeMarkerLayer.removeLayer(m);
  });
  routes = routes.filter(x=>x!==r);
  r.row.remove();
}

function toggleRoute(r, btn){
  r.visible = !r.visible;
  btn.textContent = r.visible ? "üôà Hide" : "üëÅ Show";

  if(r.polyline){
    if(r.visible) routeLayer.addLayer(r.polyline);
    else routeLayer.removeLayer(r.polyline);
  }

  [r.startMarker,r.endMarker,r.startLabelMarker,r.endLabelMarker].forEach(m=>{
    if(!m) return;
    if(r.visible) routeMarkerLayer.addLayer(m);
    else routeMarkerLayer.removeLayer(m);
  });
}

/* ======================== POLYLINE DECODER ======================== */
function decodePolyline(encoded){
  let coords=[],lat=0,lng=0,index=0;
  while(index<encoded.length){
    let b,shift=0,result=0;
    do{
      b=encoded.charCodeAt(index++)-63;
      result|=(b&0x1f)<<shift;
      shift+=5;
    }while(b>=0x20);
    const dlat=(result&1)?~(result>>1):(result>>1);
    lat+=dlat;

    shift=0; result=0;
    do{
      b=encoded.charCodeAt(index++)-63;
      result|=(b&0x1f)<<shift;
      shift+=5;
    }while(b>=0x20);
    const dlng=(result&1)?~(result>>1):(result>>1);
    lng+=dlng;

    coords.push([lat/1e5,lng/1e5]);
  }
  return coords;
}

/* ======================== GOOGLE ROUTING ======================== */
async function computeRoute(start,end,mode){
  const body={
    origin:{location:{latLng:{latitude:start[0],longitude:start[1]}}},
    destination:{location:{latLng:{latitude:end[0],longitude:end[1]}}},
    travelMode:mode
  };
  const res=await fetch("https://routes.googleapis.com/directions/v2:computeRoutes",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Goog-Api-Key":"AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M",
      "X-Goog-FieldMask":"routes.polyline.encodedPolyline"
    },
    body:JSON.stringify(body)
  });

  const data=await res.json();
  if(!data.routes) return [];
  return decodePolyline(data.routes[0].polyline.encodedPolyline);
}

/* ======================== DRAW ONE ROUTE ======================== */
async function drawRoute(r,mode){
  // Clear old layers
  if(r.polyline) routeLayer.removeLayer(r.polyline);
  [r.startMarker,r.endMarker,r.startLabelMarker,r.endLabelMarker].forEach(m=>{
    if(m) routeMarkerLayer.removeLayer(m);
  });

  function resolveLatLng(acMap,input,existing){
    if(existing) return existing;
    const ac=acMap.get(input);
    const place=ac && ac.getPlace && ac.getPlace();
    if(place && place.geometry){
      return [place.geometry.location.lat(),place.geometry.location.lng()];
    }
    return null;
  }

  r.startLatLng = resolveLatLng(startAcMap, r.startAddrInput, r.startLatLng);
  r.endLatLng   = resolveLatLng(endAcMap,   r.endAddrInput,   r.endLatLng);

  if(!r.startLatLng || !r.endLatLng) return;

  const coords = await computeRoute(r.startLatLng,r.endLatLng,mode);
  if(!coords.length) return;

  const latlngs = coords.map(p=>[p[0],p[1]]);

  const poly = L.polyline(latlngs,{
    color:r.boxInput.value,
    weight:5,
    dashArray: mode==="WALK" ? "6,10" : null
  });
  r.polyline = poly;
  if(r.visible) poly.addTo(routeLayer);

  const font=document.getElementById("labelFont").value;
  const size=document.getElementById("labelFontSize").value;

  const startMarker = L.marker(r.startLatLng,{
    draggable:true,
    icon: makeMarker(r.boxInput.value)
  });
  const endMarker = L.marker(r.endLatLng,{
    draggable:true,
    icon: makeMarker(r.boxInput.value)
  });

  if(r.visible){
    startMarker.addTo(routeMarkerLayer);
    endMarker.addTo(routeMarkerLayer);
  }

  function labelHTML(text){
    return `<div class="label-box"
              style="background:${r.boxInput.value}; color:${r.textInput.value};
                     font-family:${font}; font-size:${size};">
              ${text}
            </div>`;
  }

  const startText = r.startLabelInput.value || "Start";
  const endText   = r.endLabelInput.value   || "End";

  const startLabelMarker = L.marker(r.startLatLng,{
    icon:L.divIcon({
      html:labelHTML(startText),
      className:"",
      iconSize:[0,0],
      iconAnchor:[0,-10]
    }),
    interactive:false
  });

  const endLabelMarker = L.marker(r.endLatLng,{
    icon:L.divIcon({
      html:labelHTML(endText),
      className:"",
      iconSize:[0,0],
      iconAnchor:[0,-10]
    }),
    interactive:false
  });

  if(r.visible){
    startLabelMarker.addTo(routeMarkerLayer);
    endLabelMarker.addTo(routeMarkerLayer);
  }

  r.startMarker      = startMarker;
  r.endMarker        = endMarker;
  r.startLabelMarker = startLabelMarker;
  r.endLabelMarker   = endLabelMarker;

  // Drag behaviour: update coords and labels, then redraw route on dragend
  startMarker.on("drag", e=>{
    startLabelMarker.setLatLng(e.latlng);
  });
  endMarker.on("drag", e=>{
    endLabelMarker.setLatLng(e.latlng);
  });

  startMarker.on("dragend", async e=>{
    r.startLatLng = [e.target.getLatLng().lat, e.target.getLatLng().lng];
    await drawRoute(r,mode);
  });

  endMarker.on("dragend", async e=>{
    r.endLatLng = [e.target.getLatLng().lat, e.target.getLatLng().lng];
    await drawRoute(r,mode);
  });
}

/* ======================== DRAW ALL ROUTES ======================== */
document.getElementById("drawAllBtn").onclick = async ()=>{
  const mode=document.querySelector('input[name="mode"]:checked').value;
  for(const r of routes){
    await drawRoute(r,mode);
  }

  // Fit to bounds of all visible routes
  let b=null;
  routeLayer.eachLayer(l=>{
    if(!b) b=l.getBounds(); else b.extend(l.getBounds());
  });
  if(b) map.fitBounds(b,{padding:[40,40]});
};

/* ======================== FREE-PLACE MARKERS ======================== */
let dropMode=false;
document.getElementById("addFreeMarkerBtn").onclick=()=>{
  dropMode=true;
  alert("Click the map to place a custom marker.");
};

let freeMarkerId=1;
const freeMarkers=[];

function createFreeMarker(latlng,text,boxColor,textColor){
  const font=document.getElementById("labelFont").value;
  const size=document.getElementById("labelFontSize").value;

  const id=freeMarkerId++;

  const marker=L.marker(latlng,{
    draggable:true,
    icon: makeMarker(boxColor)
  }).addTo(freeMarkerLayer);

  const labelMarker=L.marker(latlng,{
    icon:L.divIcon({
      html:`<div class="label-box"
               style="background:${boxColor}; color:${textColor};
                      font-family:${font}; font-size:${size};">
              ${text}
            </div>`,
      className:"",
      iconSize:[0,0],
      iconAnchor:[0,-10]
    }),
    interactive:false
  }).addTo(freeMarkerLayer);

  const fm={id,marker,labelMarker,text,boxColor,textColor};
  freeMarkers.push(fm);

  marker.on("drag",e=>labelMarker.setLatLng(e.latlng));
  marker.on("click",()=>openFreeMarkerEditor(fm));
}

function openFreeMarkerEditor(fm){
  const html=`
   <div class="marker-editor">
     <h4>Edit Marker</h4>

     <label>Label:</label>
     <input id="fm-label-${fm.id}" value="${fm.text}" />

     <label>Box:
       <input type="color" id="fm-box-${fm.id}" value="${fm.boxColor}">
     </label>

     <label>Text:
       <input type="color" id="fm-text-${fm.id}" value="${fm.textColor}">
     </label>

     <div class="marker-editor-buttons">
       <button class="marker-editor-save" id="fm-save-${fm.id}">Save</button>
       <button class="marker-editor-delete" id="fm-del-${fm.id}">Delete</button>
     </div>
   </div>
  `;

  L.popup()
    .setLatLng(fm.marker.getLatLng())
    .setContent(html)
    .openOn(map);

  setTimeout(()=>{
    const labelIn=document.getElementById(`fm-label-${fm.id}`);
    const boxIn=document.getElementById(`fm-box-${fm.id}`);
    const textIn=document.getElementById(`fm-text-${fm.id}`);

    document.getElementById(`fm-save-${fm.id}`).onclick=()=>{
      fm.text=labelIn.value||"Point";
      fm.boxColor=boxIn.value;
      fm.textColor=textIn.value;

      const font=document.getElementById("labelFont").value;
      const size=document.getElementById("labelFontSize").value;

      fm.labelMarker.setIcon(L.divIcon({
        html:`<div class="label-box"
                 style="background:${fm.boxColor}; color:${fm.textColor};
                        font-family:${font}; font-size:${size};">
                ${fm.text}
              </div>`,
        className:"",
        iconSize:[0,0],
        iconAnchor:[0,-10]
      }));

      fm.marker.setIcon(makeMarker(fm.boxColor));

      map.closePopup();
    };

    document.getElementById(`fm-del-${fm.id}`).onclick=()=>{
      freeMarkerLayer.removeLayer(fm.marker);
      freeMarkerLayer.removeLayer(fm.labelMarker);
      const idx=freeMarkers.findIndex(x=>x.id===fm.id);
      freeMarkers.splice(idx,1);
      map.closePopup();
    };

  },20);
}

map.on("click",e=>{
  if(!dropMode) return;
  dropMode=false;

  const t=prompt("Marker label text:","Point");
  if(t===null) return;

  createFreeMarker(
    e.latlng,
    t||"Point",
    "#2e8b57",
    "#ffffff"
  );
});
</script>

</body>
</html>
