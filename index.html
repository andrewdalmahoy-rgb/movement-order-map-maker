<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Movement Order Map Maker</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- SortableJS for drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* Fullscreen base */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

header {
  background: #0b6fa6;
  color: white;
  padding: 12px 16px;
  font-size: 20px;
}

.layout {
  position: absolute;
  top: 56px;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  overflow: hidden;
}

/* Side panel */
#panel {
  width: 330px;
  background: #f8f9fa;
  padding: 12px;
  overflow-y: auto;
  border-right: 1px solid #ccc;
  transition: transform 0.3s ease;
}
#panel.hidden {
  transform: translateX(-330px);
}

#togglePanel {
  position: absolute;
  left: 330px;
  top: 70px;
  z-index: 9999;
  padding: 6px 10px;
  background: #0b6fa6;
  color: white;
  border-radius: 4px;
  cursor: pointer;
  border: none;
}

/* Map */
#map {
  flex: 1;
  height: 100%;
  width: 100%;
}

/* Stop rows */
.stop-row {
  display: flex;
  gap: 6px;
  align-items: center;
  background: #ffffff;
  padding: 6px;
  border-radius: 6px;
  margin-bottom: 8px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.15);
}

.drag-handle {
  cursor: grab;
  font-size: 20px;
  padding: 4px;
  user-select: none;
}

.address-input {
  flex: 1;
  padding: 6px;
  border: 1px solid #bbb;
  border-radius: 4px;
}

.label-input {
  width: 90px;
  padding: 6px;
  border: 1px solid #bbb;
  border-radius: 4px;
}

.color-input {
  width: 36px;
  height: 38px;
  padding: 0;
  border: none;
  cursor: pointer;
}

.removeStop {
  background: #b22222;
  color: white;
  border: none;
  font-size: 18px;
  border-radius: 4px;
  cursor: pointer;
  padding: 0 8px;
}

button.action {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  background: #0b6fa6;
  border: none;
  color: white;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
}

/* Label on the map */
.label-box {
  padding: 6px 10px;
  border-radius: 8px;
  font-weight: bold;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transform: translateY(-12px);
}
</style>
</head>

<body>

<header>Movement Order Map Maker</header>

<div class="layout">

  <button id="togglePanel">‚â°</button>

  <div id="panel">

    <h3>Stops</h3>
    <div id="stopContainer"></div>
    <button id="addStopBtn" class="action">‚ûï Add Stop</button>

    <h3>Label Font</h3>
    <select id="labelFont" class="action">
      <option value="Arial">Arial</option>
      <option value="Helvetica">Helvetica</option>
      <option value="Verdana">Verdana</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Georgia">Georgia</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Courier New">Courier New</option>
    </select>

    <h3>Font Size</h3>
    <select id="labelFontSize" class="action">
      <option value="12px">12px</option>
      <option value="14px" selected>14px</option>
      <option value="16px">16px</option>
      <option value="18px">18px</option>
      <option value="20px">20px</option>
    </select>

    <h3>Travel Mode</h3>
    <label><input type="radio" name="mode" value="DRIVING" checked> Driving</label><br>
    <label><input type="radio" name="mode" value="WALKING"> Walking</label>

    <button id="routeBtn" class="action">Show Route</button>
    <button id="recenterBtn" class="action">üîç Recenter Route</button>
    <button id="satToggle" class="action">üõ∞ Satellite View</button>

  </div>

  <div id="map"></div>

</div>

<script>
/* ------------------- MAP SETUP ------------------- */
const map = L.map("map").setView([52.5, -1.5], 6);
let streetTiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
let satTiles = L.tileLayer("https://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}", {
  subdomains:['mt0','mt1','mt2','mt3']
});
streetTiles.addTo(map);

let satellite = false;
document.getElementById("satToggle").onclick = () => {
  satellite = !satellite;
  if (satellite) {
    map.removeLayer(streetTiles);
    map.addLayer(satTiles);
  } else {
    map.removeLayer(satTiles);
    map.addLayer(streetTiles);
  }
  setTimeout(() => map.invalidateSize(true), 200);
};

let markerGroup = L.layerGroup().addTo(map);
let routeGroup = L.layerGroup().addTo(map);

function refitRoute() {
  if (routeGroup.getLayers().length === 0) return;
  let b = null;
  routeGroup.eachLayer(l => {
    if (!b) b = l.getBounds();
    else b.extend(l.getBounds());
  });
  map.fitBounds(b, {padding:[40,40]});
}

/* ------------------- RESIZE FIX ------------------- */
function resizeMap() {
  setTimeout(() => map.invalidateSize(true), 50);
  setTimeout(() => map.invalidateSize(true), 300);
  setTimeout(() => map.invalidateSize(true), 700);
}

/* ---------------- PANEL TOGGLE ---------------- */
const toggleBtn = document.getElementById("togglePanel");
const panel = document.getElementById("panel");
let panelOpen = true;

toggleBtn.onclick = () => {
  panelOpen = !panelOpen;
  panel.classList.toggle("hidden");
  toggleBtn.textContent = panelOpen ? "‚â°" : "‚ñ∂";
  resizeMap();
};

/* ----------------- DRAGGABLE MARKERS ---------------- */
function makeDraggable(marker, index, coords, updateRoute) {
  marker.on("drag", e => {
    const p = e.latlng;
    coords[index] = [p.lat, p.lng];
    updateRoute();
  });
}

/* ---------------- AUTOCOMPLETE ---------------- */
const acMap = new Map();

/* ---------------- ROUTE REQUEST ---------------- */
async function googleRoute(origin, dest, mode) {
  const res = await fetch(
    `https://routes.googleapis.com/directions/v2:computeRoutes`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Goog-Api-Key": "YOUR_GOOGLE_API_KEY_HERE",
        "X-Goog-FieldMask": "*"
      },
      body: JSON.stringify({
        origin: { location: { latLng: { latitude: origin[0], longitude: origin[1] }}},
        destination: { location: { latLng: { latitude: dest[0], longitude: dest[1] }}},
        travelMode: mode
      })
    }
  );
  return res.json();
}

/* ---------------- ADD STOP ROW ---------------- */
function addStopRow(defaultLabel="") {
  const row = document.createElement("div");
  row.className = "stop-row";

  row.innerHTML = `
    <div class="drag-handle">‚ò∞</div>
    <input type="text" class="address-input" placeholder="Address or postcode">
    <input type="text" class="label-input" placeholder="${defaultLabel}">
    <input type="color" class="color-input" value="#2e8b57">
    <input type="color" class="color-input" value="#ffffff">
    <button class="removeStop">‚úñ</button>
  `;

  row.querySelector(".removeStop").onclick = () => row.remove();
  document.getElementById("stopContainer").appendChild(row);

  const input = row.querySelector(".address-input");

  const ac = new google.maps.places.Autocomplete(input, {
    fields: ["geometry", "formatted_address"]
  });
  acMap.set(input, ac);
}

/* ---------------- INITIAL 2 STOPS ---------------- */
addStopRow("Start");
addStopRow("End");

/* --------------- SORTABLE REORDER ---------------- */
Sortable.create(document.getElementById("stopContainer"), {
  handle: ".drag-handle",
  animation: 150
});

/* ---------------- SHOW ROUTE ---------------- */
document.getElementById("routeBtn").onclick = async () => {
  try {
    markerGroup.clearLayers();
    routeGroup.clearLayers();

    const rows = [...document.querySelectorAll(".stop-row")];

    const coords = [];
    const labels = [];
    const boxColors = [];
    const textColors = [];

    for (let row of rows) {
      const input = row.querySelector(".address-input");
      const ac = acMap.get(input);
      const place = ac.getPlace();

      if (!place?.geometry) {
        alert("Please pick an address from the suggestions.");
        return;
      }

      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      coords.push([lat, lng]);

      labels.push(row.querySelector(".label-input").value || "Stop");
      boxColors.push(row.querySelectorAll(".color-input")[0].value);
      textColors.push(row.querySelectorAll(".color-input")[1].value);
    }

    const mode = document.querySelector("input[name='mode']:checked").value;

    const font = document.getElementById("labelFont").value;
    const size = document.getElementById("labelFontSize").value;

    /* ---- Add markers + labels ---- */
    coords.forEach((c, i) => {
      const iconUrl =
        i === 0 ? "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png" :
        i === coords.length - 1 ? "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" :
        "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png";

      const mark = L.marker(c, {
        icon: L.icon({
          iconUrl,
          shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
          iconSize:[25,41],
          iconAnchor:[12,41]
        }),
        draggable: true
      }).addTo(markerGroup);

      makeDraggable(mark, i, coords, () => drawRoute());

      L.marker(c, {
        icon: L.divIcon({
          html: `<div class="label-box"
                   style="background:${boxColors[i]};color:${textColors[i]};
                          font-family:${font};font-size:${size};">
                   ${labels[i]}
                 </div>`,
          className:"",
          iconSize:[0,0],
          iconAnchor:[40,30]
        }),
        interactive:false
      }).addTo(markerGroup);
    });

    async function drawRoute() {
      routeGroup.clearLayers();

      for (let i = 0; i < coords.length - 1; i++) {
        const r = await googleRoute(coords[i], coords[i+1], mode);
        const path = r.routes[0].polyline.encodedPolyline;
        const decoded = L.Polyline.fromEncoded(path).getLatLngs();
        
        L.polyline(decoded, {
          color: boxColors[i],
          weight: 5,
          dashArray: mode === "WALKING" ? "6, 10" : null
        }).addTo(routeGroup);
      }

      refitRoute();
    }

    await drawRoute();

  } catch (err) {
    alert("Error: " + err.message);
    console.error(err);
  }
};

/* ---------------- RECENTER ROUTE ---------------- */
document.getElementById("recenterBtn").onclick = () => refitRoute();
</script>

<!-- GOOGLE MAPS -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY_HERE&libraries=places"></script>

</body>
</html>
