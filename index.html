<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement Order Map Maker</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    header {
      background:#0b6fa6;
      color:white;
      padding:10px 16px;
      font-size: 20px;
      font-weight: 600;
    }

    .layout {
      position:absolute;
      top:48px;
      left:0; right:0; bottom:0;
    }

    #map {
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      z-index:1;
    }

    /* Leaflet controls over the map but below sidebar */
    .leaflet-control-container {
      z-index: 500;
    }

    /* Sidebar */
    .sidebar {
      position:absolute;
      top:0; bottom:0; left:0;
      width:450px;
      background:#f4f5f7;
      box-shadow:2px 0 8px rgba(0,0,0,0.2);
      padding:12px;
      overflow-y:auto;
      z-index:900;
      transition:transform 0.3s ease;
    }
    .sidebar.hidden { transform:translateX(-100%); }

    .stop-row {
      display:grid;
      grid-template-columns: 28px 1fr;
      grid-template-areas:
        "handle address"
        ". label"
        ". colors"
        ". segment";
      gap:6px 10px;
      padding:10px;
      margin-bottom:10px;
      background:white;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.15);
    }

    .drag-handle {
      grid-area:handle;
      cursor:grab;
      font-size:20px;
      user-select:none;
      padding-top:4px;
    }

    .address-input {
      grid-area:address;
      padding:7px;
      width:100%;
      border-radius:4px;
      border:1px solid #aaa;
      box-sizing:border-box;
    }

    .label-input {
      grid-area:label;
      padding:7px;
      width:100%;
      border-radius:4px;
      border:1px solid #aaa;
      box-sizing:border-box;
    }

    .color-row {
      grid-area:colors;
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
    }

    .color-input {
      width:40px;
      height:32px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      padding:0;
    }

    .segment-row {
      grid-area:segment;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .removeStop,
    .toggleSegment {
      border:none;
      border-radius:4px;
      padding:6px 10px;
      cursor:pointer;
      font-size:13px;
    }

    .removeStop {
      background:#b22222;
      color:white;
    }

    .toggleSegment {
      background:#666;
      color:white;
    }

    button.full-btn, select.full-btn {
      width:100%;
      padding:8px 10px;
      border:none;
      border-radius:4px;
      margin-top:6px;
      background:#0b6fa6;
      color:white;
      font-size:15px;
      cursor:pointer;
      box-sizing:border-box;
    }
    select.full-btn {
      background:white;
      color:#333;
      border:1px solid #aaa;
    }

    .mode-row {
      font-size:14px;
      margin-top:6px;
    }

    .label-box {
      display:inline-block;
      padding:6px 10px;
      border-radius:8px;
      font-weight:bold;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      line-height:1.2;
      pointer-events:none;
    }

    /* Floating toggle button */
    .panel-toggle {
      position:absolute;
      bottom:16px;
      left:16px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:1px solid #ccc;
      background:white;
      color:#333;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      z-index:1000;
    }

    /* Free marker button */
    .free-marker-btn {
      position:absolute;
      bottom:78px;
      left:16px;
      width:48px;
      height:48px;
      border-radius:50%;
      border:1px solid #ccc;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      z-index:1000;
    }

    /* Popup editor (for free markers) */
    .marker-editor { font-size:13px; padding:4px; }
    .marker-editor h4 { margin:0 0 6px; font-size:14px; }
    .marker-editor label { display:block; margin-top:4px; font-weight:bold; }
    .marker-editor input[type=text] {
      width:100%; padding:4px 6px;
      border-radius:4px; border:1px solid #aaa;
    }
    .marker-editor input[type=color] {
      width:40px; height:24px; border:none; border-radius:4px;
      margin-left:4px; cursor:pointer;
    }
    .marker-editor-buttons {
      display:flex; gap:6px; margin-top:8px;
    }
    .marker-editor-save {
      flex:1; background:#0b6fa6; color:white; border:none;
      padding:5px; border-radius:4px; cursor:pointer;
    }
    .marker-editor-delete {
      flex:1; background:#b22222; color:white; border:none;
      padding:5px; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body>

<header>Movement Order Map Maker</header>

<div class="layout">
  <div id="map"></div>

  <button id="panelToggle" class="panel-toggle">‚úï</button>
  <button id="addFreeMarkerBtn" class="free-marker-btn">üìç</button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <h3>Stops</h3>
    <div id="stopContainer"></div>
    <button id="addStopBtn" class="full-btn">‚ûï Add Stop</button>

    <h3>Font</h3>
    <select id="labelFont" class="full-btn">
      <option>Arial</option><option>Helvetica</option>
      <option>Verdana</option><option>Georgia</option>
      <option>Times New Roman</option><option>Courier New</option>
    </select>

    <h3>Font Size</h3>
    <select id="labelFontSize" class="full-btn">
      <option>12px</option>
      <option selected>14px</option>
      <option>16px</option><option>18px</option><option>20px</option>
    </select>

    <h3>Travel Mode</h3>
    <div class="mode-row">
      <label><input name="mode" type="radio" value="DRIVE" checked> Driving</label><br>
      <label><input name="mode" type="radio" value="WALK"> Walking</label>
    </div>

    <button id="routeBtn" class="full-btn">Show Route</button>
    <button id="recenterBtn" class="full-btn">üîç Recenter Route</button>
    <button id="satToggle" class="full-btn">üõ∞ Satellite View</button>
  </div>
</div>

<!-- Google Places & Routes -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M&libraries=places"></script>

<script>
/* ======================== MAP ======================== */
const map = L.map("map").setView([52.5, -1.5], 6);

const streets = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom:19 }
).addTo(map);

const esriSat = L.tileLayer(
 "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
 { maxZoom:19 }
);

let satelliteOn = false;

const routeLayer = L.layerGroup().addTo(map);
const routeMarkerLayer = L.layerGroup().addTo(map);
const freeMarkerLayer = L.layerGroup().addTo(map);

/* Segment storage for show/hide */
let segmentLayers = [];       // L.Polyline per leg
let segmentVisibility = [];   // true/false per leg (undefined = true)

/* ======================== SIDEBAR ======================== */
const sidebar = document.getElementById("sidebar");
const panelToggle = document.getElementById("panelToggle");
let panelOpen = true;

function updatePanelState(){
  if(panelOpen){
    sidebar.classList.remove("hidden");
    panelToggle.textContent="‚úï";
  } else {
    sidebar.classList.add("hidden");
    panelToggle.textContent="‚â°";
  }
  setTimeout(()=>map.invalidateSize(),200);
}
panelToggle.addEventListener("click",()=>{
  panelOpen=!panelOpen;
  updatePanelState();
});
updatePanelState();

/* ======================== SATELLITE ======================== */
document.getElementById("satToggle").addEventListener("click",()=>{
  satelliteOn=!satelliteOn;
  if(satelliteOn){ map.removeLayer(streets); esriSat.addTo(map); }
  else { map.removeLayer(esriSat); streets.addTo(map); }
  setTimeout(()=>map.invalidateSize(),150);
});

/* ======================== AUTOCOMPLETE ======================== */
const acMap = new Map();
function attachAutocomplete(input){
  const ac=new google.maps.places.Autocomplete(input,{fields:["geometry","formatted_address"]});
  acMap.set(input,ac);
}

/* ======================== STOPS ======================== */
const stopContainer=document.getElementById("stopContainer");

function addStopRow(defaultLabel=""){
  const row=document.createElement("div");
  row.className="stop-row";

  row.innerHTML=`
    <div class="drag-handle">‚ò∞</div>
    <input class="address-input" placeholder="Address or postcode" />
    <input class="label-input" placeholder="${defaultLabel}" />
    <div class="color-row">
      <label>Box:</label>
      <input type="color" class="color-input boxColor" value="#2e8b57"/>
      <label>Text:</label>
      <input type="color" class="color-input textColor" value="#ffffff"/>
    </div>
    <div class="segment-row">
      <button class="toggleSegment">üôà Hide</button>
      <button class="removeStop">‚úñ Remove</button>
    </div>
  `;

  const removeBtn = row.querySelector(".removeStop");
  removeBtn.addEventListener("click",()=>{
    row.remove();
    refreshSegmentButtons();
  });

  stopContainer.appendChild(row);
  attachAutocomplete(row.querySelector(".address-input"));

  refreshSegmentButtons();  // keep buttons wired up when adding rows
  return row;
}

addStopRow("Start");
addStopRow("End");

Sortable.create(stopContainer,{handle:".drag-handle",animation:150});

document.getElementById("addStopBtn").addEventListener("click",()=>addStopRow("Stop"));

/* ================= POLYLINE DECODER ================= */
function decodePolyline(encoded){
  let coords=[],lat=0,lng=0,index=0;
  while(index<encoded.length){
    let b,shift=0,result=0;
    do{ b=encoded.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
    const dlat=(result&1)?~(result>>1):(result>>1); lat+=dlat;

    shift=0; result=0;
    do{ b=encoded.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
    const dlng=(result&1)?~(result>>1):(result>>1); lng+=dlng;

    coords.push([lat/1e5,lng/1e5]);
  }
  return coords;
}

/* ================= MAKE COLOURED SVG MARKER ================= */
function makeColoredMarker(color){
  const svg=`
    <svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 0
               C7 0 0 7 0 16
               C0 30 16 48 16 48
               C16 48 32 30 32 16
               C32 7 25 0 16 0Z"
            fill="${color}"
            stroke="white" stroke-width="2"/>
      <circle cx="16" cy="16" r="6" fill="white"/>
    </svg>`;
  return L.icon({
    iconUrl:"data:image/svg+xml;base64,"+btoa(svg),
    iconSize:[32,48],
    iconAnchor:[16,48]
  });
}

/* ================= GOOGLE ROUTES ================= */
async function computeRoute(start,end,mode){
  const body={
    origin:{location:{latLng:{latitude:start[0],longitude:start[1]}}},
    destination:{location:{latLng:{latitude:end[0],longitude:end[1]}}},
    travelMode:mode
  };

  const res=await fetch("https://routes.googleapis.com/directions/v2:computeRoutes",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Goog-Api-Key":"AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M",
      "X-Goog-FieldMask":"routes.polyline.encodedPolyline"
    },
    body:JSON.stringify(body)
  });

  const data=await res.json();
  if(!data.routes) return [];
  return decodePolyline(data.routes[0].polyline.encodedPolyline);
}

/* ================= DRAW ROUTE SEGMENTS ================= */
async function drawRouteSegments(coords,boxColors,mode,fit){
  // Clear all existing polylines from the layer group
  routeLayer.clearLayers();

  // Ensure arrays are the right length
  const nSeg = Math.max(0, coords.length - 1);
  segmentLayers.length = nSeg;

  for(let i=0;i<nSeg;i++){
    const seg = await computeRoute(coords[i],coords[i+1],mode);
    if(!seg.length){
      segmentLayers[i] = null;
      continue;
    }

    const visible = (segmentVisibility[i] !== false); // default: visible

    const line = L.polyline(seg.map(p=>[p[0],p[1]]),{
      color:boxColors[i],
      weight:5,
      dashArray:mode==="WALK"?"6,10":null
    });

    if(visible){
      line.addTo(routeLayer);
    }

    segmentLayers[i] = line;
  }

  if(fit){
    let b=null;
    routeLayer.eachLayer(l=>{
      if(!b) b=l.getBounds(); else b.extend(l.getBounds());
    });
    if(b) map.fitBounds(b,{padding:[40,40]});
  }

  refreshSegmentButtons();
}

/* ================= SEGMENT TOGGLE BUTTONS ================= */
function refreshSegmentButtons(){
  const rows=[...document.querySelectorAll(".stop-row")];

  rows.forEach((row,i)=>{
    const btn=row.querySelector(".toggleSegment");
    if(!btn) return;

    // Last stop has no onward segment
    if(i>=rows.length-1){
      btn.style.display="none";
      return;
    }

    btn.style.display="inline-block";

    const visible = (segmentVisibility[i] !== false);
    btn.textContent = visible ? "üôà Hide" : "üëÅ Show";

    btn.onclick = ()=>{
      const seg = segmentLayers[i];
      if(!seg) return;

      const currentlyOnMap = map.hasLayer(seg);
      if(currentlyOnMap){
        map.removeLayer(seg);
        segmentVisibility[i] = false;
        btn.textContent="üëÅ Show";
      } else {
        seg.addTo(routeLayer);
        segmentVisibility[i] = true;
        btn.textContent="üôà Hide";
      }
    };
  });
}

/* ================= CLEAR ROUTE ================= */
function clearRoute(){
  routeLayer.clearLayers();
  routeMarkerLayer.clearLayers();
  segmentLayers = [];
  segmentVisibility = [];
  refreshSegmentButtons();
}

/* ================= SHOW ROUTE ================= */
document.getElementById("routeBtn").addEventListener("click",async()=>{

  clearRoute();

  const rows=[...document.querySelectorAll(".stop-row")];
  const coords=[], labels=[], boxColors=[], textColors=[];
  for(const r of rows){
    const input=r.querySelector(".address-input");
    const ac=acMap.get(input);
    const place=ac&&ac.getPlace();
    if(!place||!place.geometry){
      alert("Select an address from suggestions for all stops.");
      return;
    }
    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();
    coords.push([lat,lng]);
    labels.push(r.querySelector(".label-input").value||"Stop");
    boxColors.push(r.querySelector(".boxColor").value);
    textColors.push(r.querySelector(".textColor").value);
  }

  if(coords.length<2){ alert("Need start and end."); return; }

  const font=document.getElementById("labelFont").value;
  const size=document.getElementById("labelFontSize").value;
  const mode=document.querySelector('input[name="mode"]:checked').value;

  // Reset visibility when user explicitly clicks "Show Route"
  segmentVisibility = [];

  /* Place markers + labels */
  coords.forEach((c,i)=>{
    const marker=L.marker(c,{
      draggable:true,
      icon: makeColoredMarker(boxColors[i])
    }).addTo(routeMarkerLayer);

    const label=L.marker(c,{
      icon:L.divIcon({
        html:`<div class="label-box"
                 style="background:${boxColors[i]}; color:${textColors[i]};
                        font-family:${font}; font-size:${size};">
                ${labels[i]}
              </div>`,
        className:"",
        iconSize:[0,0],
        iconAnchor:[0,-10]
      }),
      interactive:false
    }).addTo(routeMarkerLayer);

    marker.on("drag",e=>{
      // Keep label anchored
      label.setLatLng(e.latlng);
      // Update local coords array used for redraw
      coords[i]=[e.latlng.lat,e.latlng.lng];
    });

    marker.on("dragend",async()=>{
      // Recalculate segments but keep segmentVisibility states
      await drawRouteSegments(coords,boxColors,mode,false);
    });
  });

  await drawRouteSegments(coords,boxColors,mode,true);
});

/* ================= RECENTER ================= */
document.getElementById("recenterBtn").addEventListener("click",()=>{
  let b=null;
  routeLayer.eachLayer(l=>{
    if(!b) b=l.getBounds(); else b.extend(l.getBounds());
  });
  if(b) map.fitBounds(b,{padding:[40,40]});
});

/* ================= FREE-PLACE MARKERS ================= */
let dropMode=false;
document.getElementById("addFreeMarkerBtn").addEventListener("click",()=>{
  dropMode=true;
  alert("Click the map to place a custom marker.");
});

let freeMarkerId=1;
const freeMarkers=[];

function createFreeMarker(latlng,text,boxColor,textColor){
  const font=document.getElementById("labelFont").value;
  const size=document.getElementById("labelFontSize").value;

  const id=freeMarkerId++;

  const marker=L.marker(latlng,{
    draggable:true,
    icon: makeColoredMarker(boxColor)
  }).addTo(freeMarkerLayer);

  const labelMarker=L.marker(latlng,{
    icon:L.divIcon({
      html:`<div class="label-box"
               style="background:${boxColor}; color:${textColor};
                      font-family:${font}; font-size:${size};">
              ${text}
            </div>`,
      className:"",
      iconSize:[0,0],
      iconAnchor:[0,-10]
    }),
    interactive:false
  }).addTo(freeMarkerLayer);

  const fm={id,marker,labelMarker,text,boxColor,textColor};
  freeMarkers.push(fm);

  marker.on("drag",e=>labelMarker.setLatLng(e.latlng));
  marker.on("click",()=>openFreeMarkerEditor(fm));
}

function openFreeMarkerEditor(fm){
  const html=`
   <div class="marker-editor">
     <h4>Edit Marker</h4>

     <label>Label:</label>
     <input id="fm-label-${fm.id}" value="${fm.text}" />

     <label>Box:
       <input type="color" id="fm-box-${fm.id}" value="${fm.boxColor}">
     </label>

     <label>Text:
       <input type="color" id="fm-text-${fm.id}" value="${fm.textColor}">
     </label>

     <div class="marker-editor-buttons">
       <button class="marker-editor-save" id="fm-save-${fm.id}">Save</button>
       <button class="marker-editor-delete" id="fm-del-${fm.id}">Delete</button>
     </div>
   </div>
  `;

  const popup=L.popup()
    .setLatLng(fm.marker.getLatLng())
    .setContent(html)
    .openOn(map);

  setTimeout(()=>{
    const labelIn=document.getElementById(`fm-label-${fm.id}`);
    const boxIn=document.getElementById(`fm-box-${fm.id}`);
    const textIn=document.getElementById(`fm-text-${fm.id}`);

    document.getElementById(`fm-save-${fm.id}`).onclick=()=>{
      fm.text=labelIn.value||"Point";
      fm.boxColor=boxIn.value;
      fm.textColor=textIn.value;

      const font=document.getElementById("labelFont").value;
      const size=document.getElementById("labelFontSize").value;

      fm.labelMarker.setIcon(L.divIcon({
        html:`<div class="label-box"
                 style="background:${fm.boxColor}; color:${fm.textColor};
                        font-family:${font}; font-size:${size};">
                ${fm.text}
              </div>`,
        className:"",
        iconSize:[0,0],
        iconAnchor:[0,-10]
      }));

      fm.marker.setIcon(makeColoredMarker(fm.boxColor));

      map.closePopup();
    };

    document.getElementById(`fm-del-${fm.id}`).onclick=()=>{
      freeMarkerLayer.removeLayer(fm.marker);
      freeMarkerLayer.removeLayer(fm.labelMarker);
      const idx=freeMarkers.findIndex(x=>x.id===fm.id);
      freeMarkers.splice(idx,1);
      map.closePopup();
    };

  },20);
}

map.on("click",e=>{
  if(!dropMode) return;
  dropMode=false;

  const t=prompt("Marker label text:","Point");
  if(t===null) return;

  createFreeMarker(
    e.latlng,
    t||"Point",
    "#2e8b57",
    "#ffffff"
  );
});
</script>

</body>
</html>
