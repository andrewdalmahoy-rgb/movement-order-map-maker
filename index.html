<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement Order Map Maker</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- SortableJS for drag-to-reorder stops -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    header {
      background:#0b6fa6;
      color:white;
      padding:10px 16px;
      font-size: 20px;
      font-weight: 600;
      box-sizing: border-box;
    }

    .layout {
      position:absolute;
      top:48px; /* header height */
      left:0;
      right:0;
      bottom:0;
      display:flex;
      overflow:hidden;
    }

    /* Sidebar that collapses to a slim bar */
    .sidebar {
      position:relative;
      width: 340px;
      max-width: 340px;
      background:#f4f5f7;
      box-shadow: 2px 0 6px rgba(0,0,0,0.15);
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      transition: width 0.3s ease;
    }

    .sidebar.collapsed {
      width: 32px;
    }

    .sidebar-inner {
      padding: 12px;
      overflow-y:auto;
      flex:1;
    }

    .sidebar.collapsed .sidebar-inner {
      display:none;
    }

    /* Vertical toggle bar */
    .sidebar-toggle {
      position:absolute;
      top:50%;
      right:-14px;
      transform:translateY(-50%);
      width:28px;
      height:70px;
      border-radius:0 8px 8px 0;
      border:none;
      background:#0b6fa6;
      color:white;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      box-shadow: 2px 0 6px rgba(0,0,0,0.35);
    }

    .sidebar.collapsed .sidebar-toggle {
      right:-14px;
    }

    /* Map */
    #map {
      flex:1;
      height:100%;
      width:100%;
    }

    /* Stop list */
    h3 {
      margin:8px 0;
    }

    .stop-row {
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px;
      margin-bottom:6px;
      background:white;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,0.15);
    }

    .drag-handle {
      cursor:grab;
      font-size:18px;
      user-select:none;
      padding:0 4px;
    }

    .address-input {
      flex:1;
      padding:6px;
      border-radius:4px;
      border:1px solid #bbb;
    }

    .label-input {
      width:90px;
      padding:6px;
      border-radius:4px;
      border:1px solid #bbb;
    }

    .color-input {
      width:34px;
      height:34px;
      border:none;
      padding:0;
      border-radius:4px;
      cursor:pointer;
    }

    .removeStop {
      background:#b22222;
      color:white;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-size:16px;
      padding:0 8px;
    }

    button.full-btn {
      width:100%;
      padding:8px 10px;
      margin-top:6px;
      border:none;
      border-radius:4px;
      background:#0b6fa6;
      color:white;
      font-size:15px;
      cursor:pointer;
    }

    /* Label on map */
    .label-box {
      padding:6px 10px;
      border-radius:8px;
      font-weight:bold;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      transform:translateY(-12px);
      pointer-events:none;
    }

    .mode-row {
      margin-top:6px;
      margin-bottom:4px;
      font-size:14px;
    }
  </style>
</head>
<body>

<header>Movement Order Map Maker</header>

<div class="layout">
  <!-- Collapsible sidebar -->
  <div id="sidebar" class="sidebar">
    <button id="sidebarToggle" class="sidebar-toggle">‚â°</button>

    <div class="sidebar-inner">
      <h3>Stops</h3>
      <div id="stopContainer"></div>
      <button id="addStopBtn" class="full-btn">‚ûï Add Stop</button>

      <h3>Label Font</h3>
      <select id="labelFont" class="full-btn">
        <option value="Arial" selected>Arial</option>
        <option value="Helvetica">Helvetica</option>
        <option value="Verdana">Verdana</option>
        <option value="Tahoma">Tahoma</option>
        <option value="Georgia">Georgia</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Courier New">Courier New</option>
      </select>

      <h3>Font Size</h3>
      <select id="labelFontSize" class="full-btn">
        <option value="12px">12px</option>
        <option value="14px" selected>14px</option>
        <option value="16px">16px</option>
        <option value="18px">18px</option>
        <option value="20px">20px</option>
      </select>

      <h3>Travel Mode</h3>
      <div class="mode-row">
        <label><input type="radio" name="mode" value="DRIVE" checked> Driving</label><br>
        <label><input type="radio" name="mode" value="WALK"> Walking</label>
      </div>

      <button id="routeBtn" class="full-btn">Show Route</button>
      <button id="recenterBtn" class="full-btn">üîç Recenter Route</button>
      <button id="satToggle" class="full-btn">üõ∞ Satellite View</button>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>
</div>

<!-- Google Maps JS (for Places + Routes) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M&libraries=places"></script>

<script>
/* ======= MAP & LAYERS ======= */
const map = L.map("map").setView([52.5, -1.5], 6);

const streets = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

const satellite = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
    maxZoom: 19,
    attribution: "Tiles &copy; Esri"
  }
);

let satelliteOn = false;

const markerLayer = L.layerGroup().addTo(map);
const routeLayer = L.layerGroup().addTo(map);

/* ======= SIDEBAR TOGGLE ======= */
const sidebar = document.getElementById("sidebar");
const sidebarToggle = document.getElementById("sidebarToggle");

sidebarToggle.addEventListener("click", () => {
  sidebar.classList.toggle("collapsed");
  sidebarToggle.textContent = sidebar.classList.contains("collapsed") ? "‚ñ∂" : "‚â°";
  setTimeout(() => map.invalidateSize(true), 320);
});

/* ======= SATELLITE TOGGLE ======= */
document.getElementById("satToggle").addEventListener("click", () => {
  satelliteOn = !satelliteOn;
  if (satelliteOn) {
    map.removeLayer(streets);
    satellite.addTo(map);
  } else {
    map.removeLayer(satellite);
    streets.addTo(map);
  }
  setTimeout(() => map.invalidateSize(true), 150);
});

/* ======= AUTOCOMPLETE HANDLING ======= */
const acMap = new Map();

function attachAutocomplete(input) {
  const ac = new google.maps.places.Autocomplete(input, {
    fields: ["geometry", "formatted_address"]
  });
  acMap.set(input, ac);
}

/* ======= STOPS UI ======= */
const stopContainer = document.getElementById("stopContainer");

function addStopRow(defaultLabel = "") {
  const row = document.createElement("div");
  row.className = "stop-row";

  row.innerHTML = `
    <div class="drag-handle">‚ò∞</div>
    <input type="text" class="address-input" placeholder="Address or postcode" />
    <input type="text" class="label-input" placeholder="${defaultLabel}" />
    <input type="color" class="color-input boxColor" value="#2e8b57" />
    <input type="color" class="color-input textColor" value="#ffffff" />
    <button class="removeStop">‚úñ</button>
  `;

  row.querySelector(".removeStop").addEventListener("click", () => row.remove());
  stopContainer.appendChild(row);

  const input = row.querySelector(".address-input");
  attachAutocomplete(input);
}

/* Initial Start and End rows */
addStopRow("Start");
addStopRow("End");

/* Make list sortable by drag handle */
Sortable.create(stopContainer, {
  handle: ".drag-handle",
  animation: 150
});

/* ======= POLYLINE DECODER (Google encoded polyline) ======= */
function decodePolyline(encoded) {
  const coords = [];
  let index = 0, lat = 0, lng = 0;

  while (index < encoded.length) {
    let b, shift = 0, result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    const dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
    lat += dlat;

    shift = 0;
    result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    const dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
    lng += dlng;

    coords.push([lat / 1e5, lng / 1e5]);
  }
  return coords;
}

/* ======= GOOGLE ROUTES REQUEST ======= */
async function computeRoute(start, end, mode) {
  const body = {
    origin: { location: { latLng: { latitude: start[0], longitude: start[1] } } },
    destination: { location: { latLng: { latitude: end[0], longitude: end[1] } } },
    travelMode: mode  // "DRIVE" or "WALK"
  };

  const res = await fetch("https://routes.googleapis.com/directions/v2:computeRoutes", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Goog-Api-Key": "AIzaSyAiFfazXbeYvgokPycjxQ0oymMFi9uQF7M",
      "X-Goog-FieldMask": "routes.polyline.encodedPolyline"
    },
    body: JSON.stringify(body)
  });

  const data = await res.json();
  if (!data.routes || !data.routes[0] || !data.routes[0].polyline) return [];
  const encoded = data.routes[0].polyline.encodedPolyline;
  return decodePolyline(encoded);
}

/* ======= CLEAR MAP ======= */
function clearMap() {
  markerLayer.clearLayers();
  routeLayer.clearLayers();
}

/* ======= RECENTER ROUTE ======= */
function recenterRoute() {
  if (routeLayer.getLayers().length === 0) return;
  let bounds = null;
  routeLayer.eachLayer(l => {
    if (!bounds) bounds = l.getBounds();
    else bounds.extend(l.getBounds());
  });
  if (bounds) map.fitBounds(bounds, { padding:[40,40] });
}

document.getElementById("recenterBtn").addEventListener("click", recenterRoute);

/* ======= SHOW ROUTE ======= */
document.getElementById("routeBtn").addEventListener("click", async () => {
  try {
    clearMap();

    const rows = [...document.querySelectorAll(".stop-row")];
    const coords = [];
    const labels = [];
    const boxColors = [];
    const textColors = [];

    for (const row of rows) {
      const input = row.querySelector(".address-input");
      const ac = acMap.get(input);
      const place = ac && ac.getPlace();
      if (!place || !place.geometry) {
        alert("Please select an address from the suggestions for every stop.");
        return;
      }
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      coords.push([lat,lng]);

      labels.push(row.querySelector(".label-input").value || "Stop");
      boxColors.push(row.querySelector(".boxColor").value);
      textColors.push(row.querySelector(".textColor").value);
    }

    if (coords.length < 2) {
      alert("Need at least a start and end point.");
      return;
    }

    const mode = document.querySelector('input[name="mode"]:checked').value; // "DRIVE" or "WALK"
    const font = document.getElementById("labelFont").value;
    const size = document.getElementById("labelFontSize").value;

    /* Create markers & labels */
    coords.forEach((c, i) => {
      const iconUrl =
        i === 0
          ? "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png"
          : i === coords.length - 1
          ? "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png"
          : "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png";

      const marker = L.marker(c, {
        icon: L.icon({
          iconUrl,
          shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
          iconSize:[25,41],
          iconAnchor:[12,41]
        }),
        draggable:true
      }).addTo(markerLayer);

      // Label marker
      const labelMarker = L.marker(c, {
        icon: L.divIcon({
          html: `<div class="label-box"
                     style="background:${boxColors[i]};
                            color:${textColors[i]};
                            font-family:${font};
                            font-size:${size};">
                    ${labels[i]}
                 </div>`,
          className:"",
          iconSize:[0,0],
          iconAnchor:[40,30]
        }),
        interactive:false
      }).addTo(markerLayer);

      // Move label live while dragging
      marker.on("drag", e => {
        labelMarker.setLatLng(e.latlng);
      });

      // After drag ends, recompute route between all points, but keep zoom
      marker.on("dragend", async () => {
        const newCoords = coords.map((pt,j) => j===i
          ? [marker.getLatLng().lat, marker.getLatLng().lng]
          : pt
        );
        coords.splice(0, coords.length, ...newCoords);
        await drawRouteSegments(coords, boxColors, mode);
      });
    });

    // Initial route draw (with fit to bounds once)
    await drawRouteSegments(coords, boxColors, mode, true);

  } catch (err) {
    console.error(err);
    alert("Error: " + err.message);
  }
});

/* ======= DRAW ROUTE SEGMENTS ======= */
async function drawRouteSegments(coords, boxColors, mode, doFit=false) {
  routeLayer.clearLayers();

  for (let i = 0; i < coords.length - 1; i++) {
    const seg = await computeRoute(coords[i], coords[i+1], mode);
    if (!seg.length) continue;

    L.polyline(seg.map(p => [p[0],p[1]]), {
      color: boxColors[i],
      weight: 5,
      dashArray: mode === "WALK" ? "6,10" : null
    }).addTo(routeLayer);
  }

  if (doFit) recenterRoute();
}

/* ======= ADD STOP BUTTON ======= */
document.getElementById("addStopBtn").addEventListener("click", () => addStopRow("Stop"));
</script>

</body>
</html>
